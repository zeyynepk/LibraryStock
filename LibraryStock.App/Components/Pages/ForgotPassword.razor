@page "/forgot"                    
@rendermode InteractiveServer       
@inject LibraryStock.App.Clean.Services.IUsersService UsersService
@inject LibraryStock.App.Clean.Services.IEmailService EmailService


<div class="forgot-screen">
    <div class="forgot-card" style="max-width:640px;border-radius:12px;padding:24px;">
        <h3 class="forgot-title"><i class="bi bi-key-fill"></i> Şifremi Unuttum</h3>

        
        @if (!codeSent)
        {
            <div class="mb-3">
                @* Kullanıcıdan kayıtlı e-posta *@
                <input class="form-control"
                       type="email"
                       placeholder="Kayıtlı e-posta"
                       @bind="email" /> @*UI’daki input ile C# tarafındaki değişken birbirini otomatik günceller.*@
            </div>

          
            @if (!string.IsNullOrWhiteSpace(error))
            {
                <div class="alert alert-danger py-2 mb-3">@error</div>
            }
            @*p = padding, m = margin t=top, b=bottom, x=left+right, y=top+bottom*@

            <button type="button" class="btn btn-primary" @onclick="SendCode">Kod Gönder</button>
        }
        else
        {
			<div class="text-muted small mb-2">@email</div> 
            @*text-muted → yazıyı soluk gri yapar,*@

            <div class="mb-2">
                @*form-control, Bootstrap’ın form elemanlarını tek tip göstermek için kullandığı sınıftır.*@
                <input class="form-control" maxlength="6"

                       placeholder="6 haneli doğrulama kodu"
                       @bind="codeInput" />
            </div>

            <div class="mb-3">
                @* Yeni şifre alanı (göz butonuyla gizle/göster yapılabiliyor) *@
                <input class="form-control"
                       placeholder="Yeni şifre"
                       autocomplete="new-password"
                       type="@(showPw ? "text" : "password")"
                       @bind="newPassword" />
            </div>

            
            @if (!string.IsNullOrWhiteSpace(error))
            {
                <div class="alert alert-danger py-2 mb-3">@error</div>
            }

            @*flex-wrap Satıra sığmayan elemanlar alt satıra kayabilir*@
            @*gap-2 elemanlar arası boşluk*@
            <div class="d-flex flex-wrap gap-2">
                @* Şifreyi gerçekten değiştirme işlemi *@
                <button type="button" class="btn btn-success" @onclick="ResetPassword">Şifreyi Sıfırla</button>

                @* Kodu yeniden gönder: İlk 60 saniye kapalıdır *@
                <button type="button" class="btn btn-outline-secondary" @onclick="Resend" disabled="@resendDisabled">
                    Kodu Yeniden Gönder

                    @if (resendDisabled) 
                    {
                        <span>(@countdownSn sn)</span>
                    }
                </button>

                @* Şifre alanını gizle/göster butonu *@
                <button type="button" class="btn btn-outline-dark" @onclick="TogglePw">
                    @(showPw ? "Şifreyi Gizle" : "Şifreyi Göster")
                </button>
            </div>
        }
    </div>
</div>

@code {
    
    private string email = "";           
    private string error = "";          
    private bool codeSent = false;       

    private string sentCode = "";        
    private DateTime? expiresAt;         // Kodun geçerlilik bitiş zamanı 

    private string codeInput = "";       
    private string newPassword = "";     
    private bool showPw = false;         

    private bool resendDisabled = true;  // "Kodu Yeniden Gönder" ilk 60 saniye kapalı
    private int countdownSn = 60;        
    private System.Timers.Timer? t;      // Her saniye bir kez çalışıp geri sayımı azaltan zamanlayıcı

   

    // Şifre alanını göster/gizle (göz butonu)
    private void TogglePw()
    {
        showPw = !showPw;
    }

    private async Task SendCode()
    {
        error = ""; // eski hatayı temizle

        if (string.IsNullOrWhiteSpace(email))
        {
            error = "E-posta zorunlu.";
            return;
        }

        var u = await UsersService.GetByEmailAsync(email);
        if (u == null)
        {
            error = "Bu e-posta ile kullanıcı bulunamadı.";
            return;
        }

        // 6 haneli rastgele kod üret
        sentCode = new Random().Next(100000, 999999).ToString();

        // Kod 10 dakika geçerli
        expiresAt = DateTime.Now.AddMinutes(10);

        try
        {
            await EmailService.SendAsync(email, "Şifre Sıfırlama Kodu", $"Kodunuz: {sentCode}");
            codeSent = true;

            
            StartResendCountdown();
        }
        catch (Exception ex)
        {
            error = "Kod gönderilemedi: " + ex.Message;
        }
    }

    private async Task ResetPassword()
    {
        error = ""; // eski hatayı temizle

        // Kod kontrolü
        if (string.IsNullOrWhiteSpace(codeInput) || codeInput.Trim() != sentCode)
        {
            error = "Doğrulama kodu hatalı.";
            return;
        }

        // Süre kontrolü
        if (expiresAt.HasValue && DateTime.Now > expiresAt.Value)
        {
            error = "Kodun süresi doldu.";
            return;
        }

        // Yeni şifre kontrolü
        if (string.IsNullOrWhiteSpace(newPassword))
        {
            error = "Yeni şifre zorunlu.";
            return;
        }

        // Şifreyi gerçekten güncelle
        var ok = await UsersService.ResetPasswordAsync(email, newPassword);
        if (!ok)
        {
            error = "Şifre güncellenemedi.";
            return;
        }

        // Başarılı alanları temizle, ilk ekrana dön, geri sayım/timer'ı kapat
        email = codeInput = newPassword = sentCode = "";
        codeSent = false;
        StopTimer();
    }


    private async Task Resend()
    {
        if (!resendDisabled)
            await SendCode();
    }

   
    private void StartResendCountdown()
    {
        resendDisabled = true;   // buton kilitli
        countdownSn = 60;        
        StopTimer();              // eski timer varsa kapat

        t = new System.Timers.Timer(1000) { AutoReset = true }; // her 1 sn'de bir çalış
        t.Elapsed += OnTimerElapsed; // Elapsed: Timer süresi her dolduğunda (örn. her 1 sn) tetiklenen olay; tetiklenince OnTimerElapsed çalışır.
        t.Start();
    }

    
    private void StopTimer()
    {
        if (t != null)
        {
            t.Stop();
            t.Elapsed -= OnTimerElapsed;
            t.Dispose();
            t = null;
        }
    }

    
    private void OnTimerElapsed(object? s, System.Timers.ElapsedEventArgs e)
    {
        countdownSn--;

        if (countdownSn <= 0)
        {
            resendDisabled = false; // buton artık tıklanabilir
            StopTimer();            
        }

        InvokeAsync(StateHasChanged); // sayıyı ekranda güncelle
    }
}
