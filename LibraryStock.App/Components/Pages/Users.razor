@page "/personelyonetim"
@rendermode InteractiveServer
@attribute [Authorize(Roles = "Admin")]
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Components.Web
@using LibraryStock.App.Models
@using LibraryStock.App.Clean.Services
@inject IUsersService UsersService

<h3>👥 Personel Yönetimi</h3>

@if (debug && !string.IsNullOrWhiteSpace(lastError))
{
    <div style="background:#fee2e2; color:#991b1b; border:1px solid #fecaca; padding:10px; border-radius:8px; margin-bottom:12px; font-size:.9rem;">
        <strong>Hata:</strong>
        <pre style="white-space:pre-wrap; margin:6px 0 0 0;">@lastError</pre>
    </div>
}

<div class="users-screen">

    <div class="input-group mb-3" style="max-width:620px;">
        <button type="button" class="btn btn-primary" @onclick="NewUser">+ Yeni Kullanıcı</button>
    </div>

    @if (loading)
    {
        <p>Yükleniyor…</p>
    }
    else if (users is null || users.Count == 0)
    {
        <p>Kayıt bulunamadı.</p>
    }
    else
    {
        <table class="table table-hover table-sm">
            <thead>
                <tr>
                    <th style="width:80px;">ID</th>
                    <th style="width:180px;">Kullanıcı Adı</th>
                    <th style="width:220px;">E-posta</th>
                    <th style="width:140px;">Şifre</th>
                    <th style="width:120px;">Rol</th>
                    <th style="width:160px;">Son Giriş</th>
                    <th style="width:160px;">Oluşturma</th>
                    <th class="text-end" style="width:220px;">İşlemler</th>
                </tr>
            </thead>

            <tbody>
                @foreach (var u in users)
                {
                    <tr @key="u.Id">
                        <td>@u.Id</td>
                        <td>@u.UserName</td>
                        <td>@u.Email</td>
                        <td>@u.Password</td>
                        <td>@(u.Role == Role.Admin ? "Admin" : "Personel")</td>
                        <td>@(u.LastLoginDate?.ToString("dd.MM.yyyy HH:mm") ?? "-")</td>
                        <td>@string.Format("{0:dd.MM.yyyy HH:mm}", u.CreatedAdd)</td>
                        <td class="text-end">
                            <button type="button" class="btn btn-sm btn-outline-primary me-2"
                                    @onclick="() => EditUser(u)">
                                Düzenle
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-danger"
                                    @onclick="() => AskDelete(u)">
                                Sil
                            </button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    }

    @if (showForm)
    {
        <div @key="formCtx" style="position:fixed; inset:0; background:rgba(0,0,0,.45); z-index:9999;">
            <div style="max-width:720px; margin:6rem auto; background:#fff;
                                border-radius:12px; overflow:hidden;
                                box-shadow:0 10px 40px rgba(0,0,0,.2)">
                <div style="display:flex; align-items:center; justify-content:space-between;
                                    padding:12px 16px; border-bottom:1px solid #eee">
                    <strong>@formTitle</strong>
                    <button type="button" class="btn btn-sm btn-outline-secondary" @onclick="CloseForm">Kapat</button>
                </div>

                <!-- ✅ Validation eklenmiş form -->
                <EditForm EditContext="formCtx" OnValidSubmit="Save">
                    <DataAnnotationsValidator />
                    <ValidationSummary />

                    <div class="p-3">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Kullanıcı Adı</label>
                                <InputText class="form-control" @bind-Value="model.UserName" />
                                <ValidationMessage For="@(() => model.UserName)" />
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">E-posta</label>
                                <InputText class="form-control" @bind-Value="model.Email" />
                                <ValidationMessage For="@(() => model.Email)" />
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">Şifre</label>
                                <InputText class="form-control" Type="password"
                                           @bind-Value="model.Password"
                                           placeholder="Boş bırakılırsa mevcut şifre korunur" />
                                <ValidationMessage For="@(() => model.Password)" />
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">Rol</label>
                                <InputSelect class="form-select" @bind-Value="model.Role">
                                    <option value="@Role.Personel">Personel</option>
                                    <option value="@Role.Admin">Admin</option>
                                </InputSelect>
                                <ValidationMessage For="@(() => model.Role)" />
                            </div>
                        </div>

                        <div class="d-flex gap-2 mt-3">
                            <button type="submit" class="btn btn-success">Kaydet</button>
                            <button type="button" class="btn btn-secondary" @onclick="CloseForm">Vazgeç</button>
                        </div>
                    </div>
                </EditForm>
            </div>
        </div>
    }

    @if (showDelete)
    {
        <div @key="deleteTarget?.Id" style="position:fixed; inset:0; background:rgba(0,0,0,.45); z-index:9999;">
            <div style="max-width:520px; margin:8rem auto; background:#fff;
                                border-radius:12px; overflow:hidden;
                                box-shadow:0 10px 40px rgba(0,0,0,.2)">
                <div class="p-3">
                    <p class="mb-3"><strong>@deleteTarget?.UserName</strong> kullanıcısını silmek istiyor musun?</p>
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-danger" @onclick="DeleteConfirmed">Evet, Sil</button>
                        <button type="button" class="btn btn-secondary" @onclick="CloseDelete">Vazgeç</button>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private bool debug = true;
    private string? lastError;
    private bool loading = true;
    private List<User> users = new();
    private EditContext? formCtx;
    private bool showForm = false;
    private string formTitle = "Yeni Kullanıcı";
    private User model = new User();
    private bool showDelete = false;
    private User? deleteTarget = null;

    protected override async Task OnInitializedAsync()
    {
        await Load();
    }

    private async Task Load()
    {
        try
        {
            loading = true;
            users = await UsersService.GetAsync(string.Empty);
            loading = false;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            lastError = ex.ToString();
            loading = false;
            StateHasChanged();
        }
    }

    private void NewUser()
    {
        model = new User
        {
            CreatedAdd = DateTime.Now,
            LastLoginDate = null,
            Role = Role.Personel,
            Password = string.Empty
        };
        formCtx = new EditContext(model);
        formTitle = "Yeni Kullanıcı";
        showForm = true;
    }

    private void EditUser(User u)
    {
        model = new User
        {
            Id = u.Id,
            UserName = u.UserName,
            Email = u.Email,
            Password = string.Empty,
            Role = u.Role,
            LastLoginDate = u.LastLoginDate,
            CreatedAdd = u.CreatedAdd
        };
        formCtx = new EditContext(model);
        formTitle = "Kullanıcı Düzenle";
        showForm = true;
    }

    private void CloseForm()
    {
        showForm = false;
        formCtx = null;
    }

    private async Task Save()
    {
        try
        {
            if (model.Id == 0)
            {
                if (string.IsNullOrWhiteSpace(model.Password)) return;
                await UsersService.AddAsync(model);
            }
            else
            {
                var existing = await UsersService.GetByIdAsync(model.Id);
                if (existing is null) return;

                existing.UserName = model.UserName;
                existing.Email = model.Email;
                existing.Role = model.Role;

                if (!string.IsNullOrWhiteSpace(model.Password))
                    existing.Password = model.Password;

                await UsersService.UpdateAsync(existing);
            }

            showForm = false;
            await Load();
            formCtx = null;
        }
        catch (Exception ex)
        {
            lastError = ex.ToString();
            StateHasChanged();
        }
    }

    private void AskDelete(User u)
    {
        deleteTarget = u;
        showDelete = true;
    }

    private void CloseDelete()
    {
        showDelete = false;
        deleteTarget = null;
    }

    private async Task DeleteConfirmed()
    {
        try
        {
            if (deleteTarget != null)
                await UsersService.DeleteAsync(deleteTarget.Id);

            showDelete = false;
            deleteTarget = null;
            await Load();
        }
        catch (Exception ex)
        {
            lastError = ex.ToString();
            StateHasChanged();
        }
    }
}
