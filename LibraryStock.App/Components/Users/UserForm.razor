@* @using LibraryStock.App.Models
@inject LibraryStock.App.Clean.Services.IUsersService UsersService

@if (Visible)
{
	<div class="card mt-3">
		<div class="card-header">
			<strong>@GetTitle()</strong>
		</div>
		<div class="card-body">
			<div class="mb-3">
				<label class="form-label">Kullanıcı Adı</label>
				<input class="form-control" @bind="editModel.UserName" />
				@if (!string.IsNullOrEmpty(errorUserName))
				{
					<div class="text-danger small mt-1">@errorUserName</div>
				}
			</div>
			<div class="mb-3">
				<label class="form-label">E-posta</label>
				<input class="form-control" type="email" @bind="editModel.Email" />	
				@if (!string.IsNullOrEmpty(errorEmail))
				{
					<div class="text-danger small mt-1">@errorEmail</div>
				}
			</div>

			<div class="mb-3">
				<label class="form-label">Şifre</label>
				<input class="form-control" type="password" @bind="editModel.Password" />
				@if (!string.IsNullOrEmpty(errorPassword))
				{
					<div class="text-danger small mt-1">@errorPassword</div>
				}
			</div>

			<div class="mb-3">
				<label class="form-label">Rol</label>
				<select class="form-select" @bind="roleValue">
					<option value="Admin">Admin</option>
					<option value="Personel">Personel</option>
				</select>
			</div>

			@if (!string.IsNullOrEmpty(errorGeneral))
			{
				<div class="alert alert-danger py-2">@errorGeneral</div>
			}

			<div class="d-flex gap-2">
				<button type="button" class="btn btn-success" @onclick="SaveAsync">Kaydet</button>
				<button type="button" class="btn btn-secondary" @onclick="Cancel">Vazgeç</button>
			</div>
		</div>
	</div>
}

@code{
	[Parameter] public User User { get; set; }
	[Parameter] public bool Visible { get; set; } 
	[Parameter] public EventCallback OnSaved { get; set; }
	[Parameter] public EventCallback OnCancel{ get; set; }

	private User editModel = new User();
	private string roleValue = "Personel";

	private string errorUserName = "";
	private string errorEmail = "";
	private string errorPassword = "";
	private string errorGeneral = "";

	protected override void OnParametersSet()
	{
		if(User != null)
		{
			if(editModel == null)
			{
				editModel = new User();
			}

			editModel.Id = User.Id;
			editModel.UserName = User.UserName;
			editModel.Email = User.Email;
			editModel.Password = User.Password;
			editModel.LastLoginDate = User.LastLoginDate;
			editModel.CreatedAdd = User.CreatedAdd;

			roleValue = (User.Id == 0) ? "Personel" : User.Role.ToString();
		}
		else
		{
			editModel = new User();
			roleValue = "Personel";
		}

		errorUserName = "";
		errorEmail = "";
		errorPassword = "";
		errorGeneral = "";
	}

	private string GetTitle()
	{
		if(User != null && User.Id > 0)
		{
			return "Personel Güncelle";
		}
		return "Yeni Personel Ekle";
	}

	private async Task SaveAsync()
	{
		bool ok = true;

		if (string.IsNullOrWhiteSpace(editModel.UserName))
		{
			errorUserName = "Kullanıcı adı zorunlu.";
			ok = false;
		}
		else
		{
			errorUserName = "";
		}
		if (string.IsNullOrWhiteSpace(editModel.Email))
		{
			errorEmail = "E-posta zorunlu.";
			ok = false;
		}
		else
		{
			errorEmail = "";
		}
		if(editModel.Id == 0 && string.IsNullOrWhiteSpace(editModel.Password))
		{
			errorPassword = "Şifre zorunlu.";
			ok = false;
		}
		else
		{
			errorPassword = "";
		}

		if (!ok)
		{
			return;
		}
		if(roleValue == "Admin")
		{
			editModel.Role = Role.Admin;
		}
		else
		{
			editModel.Role = Role.Personel;
		}

		try
		{
			if(editModel.Id == 0)
			{
				var added = await UsersService.AddAsync(editModel);
				if(added == null)
				{
					errorGeneral = "Kayıt eklenemedi";
					return;
				}
			}
			else
			{
				bool okUpdate = await UsersService.UpdateAsync(editModel);
				if (!okUpdate)
				{
					errorGeneral = "Kayıt güncellenemedi";
					return;
				}
			}
			errorGeneral = "";

			if (OnSaved.HasDelegate)
			{
				await OnSaved.InvokeAsync(null);
			}
		}
		catch(Exception ex)
		{
			errorGeneral = "Hata" + ex.Message;
		}
	}

	private async Task Cancel()
	{
		if (OnCancel.HasDelegate)
		{
			await OnCancel.InvokeAsync(null);
		}
	}
}
 *@